<main class="flex items-start justify-center min-h-screen bg-gray-100 dark:bg-black">
  <% content_for :title, "Projects" %>

  <div class="w-full max-w-5xl mx-auto my-10">
    <h1 class="text-4xl font-extrabold text-gray-900 dark:text-white mb-8 text-center">
      Dashboard
    </h1>
    <% if @posts.any? %>
      <div class="grid grid-cols-1 md:grid-cols-1 gap-8">
        <% @posts.each do |post| %>
          <div class="bg-white border border-gray-200 rounded-xl shadow-xl p-6 flex flex-col items-center dark:bg-black">
            <h2 class="dark:text-white <%= post.title.length < 75 ? 'text-2xl font-bold text-gray-900 mb-4 break-words text-center' : 'text-2xl font-bold text-gray-900 mb-4 break-words text-left w-full' %>">
              <%= post.title %>
            </h2>
            <div class="w-full flex justify-center">
              <p class="dark:text-white text-2xl text-gray-900 mb-4 break-words text-center max-w-2xl">
                <%= post.description
                    .split(/\s+/)
                    .each_slice(10)
                    .map { |words| words.join(' ') }
                    .join('<br>')
                    .html_safe %>
              </p>
            </div>
            <br>
            <h2 class="dark:text-white text-2xl text-gray-900 mb-4 break-words text-center w-full">
              Repo link:
              <%= link_to post.repo_link, post.repo_link,
                    target: "_blank",
                    rel: "noopener",
                    class: "text-blue-600 underline hover:text-blue-800" %>
            </h2>
            <h2 class="dark:text-white text-2xl text-gray-900 mb-4 break-words text-center w-full">
              Live Demo link:
              <%= link_to post.demo_link, post.demo_link,
                    target: "_blank",
                    rel: "noopener",
                    class: "text-blue-600 underline hover:text-blue-800" %>
            </h2>
            <% if post.screenshot.attached? %>
              <%= image_tag post.screenshot, alt: "#{post.title} screenshot", class: "rounded mb-4 shadow max-w-full" %>
            <% end %>
            <%= link_to post.user.user_name, profile_by_username_path(post.user.user_name),
                  class: "text-blue-600 dark:text-blue-300 hover:underline font-semibold" %>
            <div>
              <p class="dark:text-white">
                <% if post.is_public? %>
                  Public Project
                <% else %>
                  Private Project
                <% end %>
              </p>
            </div>
            <% if post.created_at == post.updated_at %>
              <p class="text-sm text-gray-500 mb-4 text-center w-full dark:text-white">
                <span class="font-semibold text-gray-700 dark:text-white">Created:</span>
                <time class="user-local-time" datetime="<%= post.created_at.iso8601 %>">
                  <%= post.created_at.strftime("%m/%d/%Y %I:%M %p") %>
                </time>
              </p>
            <% else %>
              <p class="text-sm text-gray-500 mb-4 text-center w-full">
                <span class="font-semibold text-gray-700 dark:text-white">Updated:</span>
                <time class="user-local-time dark:text-white" datetime="<%= post.updated_at.iso8601 %>">
                  <%= post.updated_at.strftime("%m/%d/%Y %I:%M %p") %>
                </time>
              </p>
            <% end %>
            <div class="flex flex-col md:flex-row justify-center items-center gap-3 mt-2 w-full">
              <%= link_to "Show", user_post_path(user_name: post.user.user_name, slug: post.slug), class: "px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-900 font-medium shadow-sm transition w-full md:w-auto text-center" %>

              <% if post.user == current_user %>
                <%= link_to "Edit", edit_post_path(post), class: "px-4 py-2 rounded bg-blue-100 hover:bg-blue-200 text-blue-800 font-medium shadow-sm transition w-full md:w-auto text-center" %>

                <!-- Delete button triggers modal -->
                <button onclick="openDeleteProjectModal(this)" 
                        data-delete-url="<%= post_path(post) %>"
                        class="px-4 py-2 rounded bg-red-600 hover:bg-red-700 text-white font-medium shadow-sm transition w-full md:w-auto text-center">
                  Delete
                </button>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="py-20 flex flex-col items-center">
        <p class="text-xl text-gray-400 font-medium mb-4">No projects found.</p>
      </div>
    <% end %>
  </div>
</main>

<!-- Delete Project Modal -->
<div id="deleteProjectModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60 hidden">
  <div class="bg-white dark:bg-gray-900 rounded-lg shadow-xl w-full max-w-md p-8 mx-2">
    <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Delete Project</h2>
    <p class="mb-6 text-gray-600 dark:text-gray-200">
      Are you sure you want to permanently delete this project? This action cannot be undone.
      <br />
      Please type <strong>delete project</strong> to confirm.
    </p>

    <input id="delete-project-confirm-input" type="text" placeholder="Type 'delete project' here"
           class="w-full border border-gray-300 dark:bg-gray-800 dark:text-white rounded px-3 py-2 mb-6 focus:outline-none focus:ring-2 focus:ring-red-500" />

    <div class="flex gap-3 justify-end">
      <button type="button" onclick="closeDeleteProjectModal()" 
              class="px-4 py-2 rounded bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-700">
        Cancel
      </button>

      <form id="delete-project-form" method="post" action="" class="inline">
        <input type="hidden" name="_method" value="delete" />
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <button id="confirm-delete-project-btn" type="submit" disabled
                class="px-4 py-2 rounded bg-red-600 text-white font-semibold hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
          Delete Project
        </button>
      </form>
    </div>
  </div>
</div>

<script>
function openDeleteProjectModal(button) {
  const modal = document.getElementById("deleteProjectModal");
  const input = document.getElementById("delete-project-confirm-input");
  const deleteForm = document.getElementById("delete-project-form");
  const deleteBtn = document.getElementById("confirm-delete-project-btn");

  modal.classList.remove("hidden");
  input.value = "";
  deleteBtn.disabled = true;
  input.focus();

  // Set form action dynamically using data attribute from button
  deleteForm.action = button.dataset.deleteUrl;

  // Remove previous event listeners to avoid duplicates (optional)
  input.replaceWith(input.cloneNode(true));
  const newInput = document.getElementById("delete-project-confirm-input");

  // Add input listener to enable button based on exact input
  newInput.addEventListener("input", () => {
    deleteBtn.disabled = (newInput.value.trim().toLowerCase() !== "delete project");
  });
}

function closeDeleteProjectModal() {
  document.getElementById("deleteProjectModal").classList.add("hidden");
}

// Remove the old event listener setup inside DOMContentLoaded if present

</script>
